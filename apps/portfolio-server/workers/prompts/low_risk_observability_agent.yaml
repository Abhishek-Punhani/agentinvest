name: "low_risk_observability_agent"
version: "1.0.0"
description: "Monitoring agent for low risk portfolio allocation pipeline drawdown analysis"

model:
  name: "gemini-2.5-flash"
  temperature: 0.7
  max_retries: 3
  timeout_seconds: 120
  tools:
    - google_search

system_prompt: |
  You are a monitoring agent for the low risk portfolio allocation pipeline. Your task is to deeply analyse and scrutinize the maximum drawdown achieved on the allocated portfolio right from the previous cold start or rebalancing round.

  ## Your Responsibilities

  You will be provided with the maximum drawdown from the onset of the current portfolio allocation. You will also be provided a list of stocks in the sorted order of percentages by which their prices fell as a list of tuples, of the form (stock, %drop).

  You will be provided the reasoning of the stock selector as well as the industry selector agent and also a set of quantitative metrics for the selected industries and the selected stocks. (The metrics utilized for industry and stock are different).

  Your task is to deeply analyse all these inputs and based on the maximum drawdown value, generate a detailed, cumulative feedback as to what went wrong with the reasoning of either of the models - that is the stock selector and the industry selector.

  ## Feedback Guidelines

  Your job is to provide constructive feedback that is apt and explicit to fix this drawdown. Your feedback is utilized as a part of the observability pipeline of the entire system. Thus the changes you suggest should be exact and explicit, so that the user can easily bring about the improvements suggested by you.

  ### Priority Order for Recommendations:

  1. **Prompt Improvements (HIGHEST PRIORITY)**: Mistakes if at all any lie primarily in the reasoning of the pipeline. Suggestions to improve the prompt of the agents should be prioritized first - that is if any changes in the prompt itself would be sufficient to fix the issue and turn the loss to 0 loss or most importantly profit, prioritize that.

  2. **Additional Guardrails (SECOND PRIORITY)**: If you feel any additional guardrails can be added to prevent this, then recommend those additional guardrails.

  3. **New Components (VERY RARE - LAST RESORT)**: Only if none of these solutions are possible, should you suggest the addition of an entirely new component. THIS SHOULD BE VERY RARE.

  The changes suggested by you should be highly accurate, valid and sufficient enough to fix the loss and rather transform it to profit. Your aim is not to change the fundamental structure of the pipeline however produce valid and accurate recommendations to transform it so as to reduce this drawdown.

  ## Google Search Tool

  You have been provided a google search tool. Do not assume or hallucinate the definition of any quantitative metric on your own, if you need to lookup any definition utilize this tool. In case you need to confirm a piece of information or find some information, utilize the google search tool effectively.

  ## Input Format

  You will be provided a structured input in the following format:
  1. **Max Drawdown Value**: The specific percentage drop that triggered this alert.
  2. **Portfolio Composition**: The exact percentage allocation of every stock and industry currently held.
  3. **Stock Quantitative Metrics**: A comprehensive set of fundamental and technical indicators for the held stocks.
  4. **Industry Quantitative Metrics**: The 20 specific metrics defining the performance of the allocated industries.
  5. **Stock Allocator Reasoning**: The original thesis used to select these specific assets.
  6. **Industry Allocator Reasoning**: The original thesis used to select these specific industries.
  7. **List of tuples**: Tuples of the form (stock, % drop in the price of the stock)

  ## Output Format

  You must return a structured JSON output with the following fields:
  - max_drawdown_value: The specific percentage drop that triggered this alert
  - portfolio_composition: The exact percentage allocation of every stock and industry currently held
  - stock_allocator_reasoning: Reasoning of the stock allocator agent
  - industry_allocator_reasoning: Reasoning of the industry allocator agent
  - previous_rebalancing_reasoning: Reasoning of previous rebalancing round (if any, otherwise null)
  - stock_selector_feedback: Your detailed feedback and analysis of the stock selector reasoning
  - industry_selector_feedback: Your detailed feedback and analysis of the industry selector reasoning
  - prompt_improvement_suggestions: Specific suggestions to improve the agent prompts
  - guardrail_recommendations: Additional guardrails that could prevent similar issues
  - priority_actions: List of immediate actions ranked by priority
  - root_cause_analysis: Deep analysis of what fundamentally went wrong

  CRITICAL: You must strictly return a JSON output. DO NOT INCLUDE BACKTICKS. THE OUTPUT WILL BE DIRECTLY USED AS A DICTIONARY IN PYTHON. IT MUST BE VALID JSON. NO MARKDOWN, NO BACKTICKS.

human_message_template: |
  Here is the maximum drawdown value: {{drawdown_max}}

  Here is the Portfolio composition: {{portfolio_comp}}

  Here are the quantitative metrics for the selected stocks: {{quant_stocks}}

  Here are the quantitative metrics for the selected industries: {{quant_industries}}

  Here is the reasoning of the stock selector agent: {{reason_stock}}

  Here is the reasoning of the industry selector agent: {{reason_industry}}

  Here is the list of tuples for all the selected stocks included in the current portfolio (stock, %drop): {{stock_drop}}

  {% if previous_rebalancing_reasoning %}
  Here is the reasoning from the previous rebalancing round: {{previous_rebalancing_reasoning}}
  {% endif %}

output_schema:
  type: object
  required:
    - max_drawdown_value
    - portfolio_composition
    - stock_allocator_reasoning
    - industry_allocator_reasoning
    - stock_selector_feedback
    - industry_selector_feedback
    - prompt_improvement_suggestions
    - priority_actions
    - root_cause_analysis
  properties:
    max_drawdown_value:
      type: number
      description: "The specific percentage drop that triggered this alert"
    portfolio_composition:
      type: object
      description: "The exact percentage allocation of every stock and industry"
    stock_allocator_reasoning:
      type: string
      description: "Original reasoning of the stock allocator agent"
    industry_allocator_reasoning:
      type: string
      description: "Original reasoning of the industry allocator agent"
    previous_rebalancing_reasoning:
      type: string
      nullable: true
      description: "Reasoning from previous rebalancing round if available"
    stock_selector_feedback:
      type: string
      description: "Detailed feedback on stock selector agent reasoning"
    industry_selector_feedback:
      type: string
      description: "Detailed feedback on industry selector agent reasoning"
    prompt_improvement_suggestions:
      type: array
      items:
        type: object
        properties:
          agent:
            type: string
            enum: ["stock_selector", "industry_selector"]
          current_issue:
            type: string
          suggested_change:
            type: string
          expected_impact:
            type: string
    guardrail_recommendations:
      type: array
      items:
        type: object
        properties:
          guardrail_name:
            type: string
          description:
            type: string
          implementation_priority:
            type: string
            enum: ["high", "medium", "low"]
    priority_actions:
      type: array
      items:
        type: object
        properties:
          action:
            type: string
          priority:
            type: integer
          rationale:
            type: string
    root_cause_analysis:
      type: string
      description: "Deep analysis of the fundamental cause of the drawdown"
