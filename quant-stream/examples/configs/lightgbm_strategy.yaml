# Advanced LightGBM strategy with comprehensive configuration
# This example demonstrates full feature engineering and model configuration

data:
  path: ".data/indian_stock_market_nifty500.csv"
  start_date: "2021-06-01"
  end_date: "2021-12-31"
  symbol_col: "symbol"
  timestamp_col: "timestamp"

# Named features (verbose format)
features:
  # Price momentum
  - name: "return_1d"
    expression: "DELTA($close, 1)"
  
  - name: "return_5d"
    expression: "DELTA($close, 5)"
  
  - name: "return_20d"
    expression: "DELTA($close, 20)"
  
  # Technical indicators
  - name: "rsi_14"
    expression: "RSI($close, 14)"
  
  - name: "macd"
    expression: "MACD($close, 12, 26, 9)"
  
  # Moving averages
  - name: "sma_20"
    expression: "SMA($close, 20)"
  
  - name: "sma_50"
    expression: "SMA($close, 50)"
  
  # Price position
  - name: "price_vs_sma20"
    expression: "DIVIDE(SUBTRACT($close, SMA($close, 20)), SMA($close, 20))"
  
  - name: "price_vs_sma50"
    expression: "DIVIDE(SUBTRACT($close, SMA($close, 50)), SMA($close, 50))"
  
  # Volume indicators
  - name: "volume_ratio"
    expression: "DIVIDE($volume, SMA($volume, 20))"
  
  # Volatility
  - name: "volatility_20d"
    expression: "TS_STD($close, 20)"
  
  - name: "volatility_60d"
    expression: "TS_STD($close, 60)"
  
  # High-low range
  - name: "high_low_ratio"
    expression: "DIVIDE(SUBTRACT($high, $low), $close)"

model:
  type: "LightGBM"
  # Explicit feature selection - use all computed factors plus some inline expressions
  features:
    # Reference all computed factors by name
    - "return_1d"
    - "return_5d"
    - "return_20d"
    - "rsi_14"
    - "macd"
    - "sma_20"
    - "sma_50"
    - "price_vs_sma20"
    - "price_vs_sma50"
    - "volume_ratio"
    - "volatility_20d"
    - "volatility_60d"
    - "high_low_ratio"
    # Add inline expressions for additional features
    - "RANK(TS_PCTCHANGE($close, 10))"
    - "TS_CORR($close, $volume, 20)"
  include_ohlcv: false
  params:
    # Comprehensive LightGBM hyperparameters (qlib-style)
    objective: "regression"
    metric: "l2"
    boosting_type: "gbdt"
    learning_rate: 0.03
    num_leaves: 63
    max_depth: 6
    min_data_in_leaf: 100
    subsample: 0.8  # bagging_fraction
    subsample_freq: 5  # bagging_freq
    colsample_bytree: 0.8  # feature_fraction
    reg_alpha: 0.1  # lambda_l1
    reg_lambda: 0.1  # lambda_l2
    random_state: 42
    verbose: -1
    num_threads: 4
    # Training parameters
    num_boost_round: 300
    early_stopping_rounds: 20
  target: "forward_return_1d"

strategy:
  type: "TopkDropout"
  params:
    topk: 40
    n_drop: 8
    method: "signal"
    hold_periods: 5

backtest:
  segments:
    train: ["2020-01-01", "2022-06-30"]
    test: ["2022-07-01", "2023-12-31"]
  initial_capital: 5000000
  commission: 0.0015
  slippage: 0.0010
  min_commission: 5.0
  rebalance_frequency: 5

experiment:
  name: "advanced_lgbm_strategy"
  tracking_uri: "sqlite:///mlruns.db"
  run_name: "lgbm_13_factors"
  tags:
    strategy: "multi_factor"
    model: "LightGBM"
    factors: "13"
    rebalance: "weekly"
